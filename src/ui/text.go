package ui

import "Famicom-emulator/ppu"

// MARK: 変数定義
var (
	bitmapFonts = map[rune]FontTile{
		'A': {
			0x18, 0x3C, 0x7E, 0x77, 0x7F, 0x7F, 0x77, 0x33,
			0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00,
		},
		'B': {
			0x7C, 0x7E, 0x77, 0x7F, 0x7E, 0x77, 0x7F, 0x3E,
			0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00,
		},
		'C': {
			0x3C, 0x7E, 0x37, 0x07, 0x07, 0x67, 0x3F, 0x1E,
			0x3C, 0x66, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00,
		},
		'D': {
			0xF8, 0xFC, 0xE6, 0xE7, 0xE7, 0xEF, 0xFE, 0x7C,
			0xF8, 0xCC, 0xC6, 0xC6, 0xC6, 0xCC, 0xF8, 0x00,
		},
		'E': {
			0x7E, 0x7F, 0x70, 0x78, 0x7C, 0x70, 0x7E, 0x3F,
			0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00,
		},
		'F': {
			0x7E, 0x7F, 0x70, 0x78, 0x7C, 0x70, 0x70, 0x30,
			0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00,
		},
		'G': {
			0x3C, 0x7E, 0x37, 0x07, 0x77, 0x7F, 0x3F, 0x1E,
			0x3C, 0x66, 0x06, 0x06, 0x76, 0x66, 0x3C, 0x00,
		},
		'H': {
			0xC6, 0xE7, 0xE7, 0xFF, 0xFF, 0xE7, 0xE7, 0x63,
			0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00,
		},
		'I': {
			0x3C, 0x1E, 0x1C, 0x1C, 0x1C, 0x1C, 0x3C, 0x1E,
			0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00,
		},
		'J': {
			0x06, 0x07, 0x07, 0x07, 0x07, 0x67, 0x3F, 0x1E,
			0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00,
		},
		'K': {
			0x66, 0x7F, 0x7E, 0x7C, 0x78, 0x7C, 0x76, 0x33,
			0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00,
		},
		'L': {
			0x60, 0x70, 0x70, 0x70, 0x70, 0x70, 0x7E, 0x3F,
			0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00,
		},
		'M': {
			0xC6, 0xEF, 0xFF, 0xFF, 0xEF, 0xE7, 0xE7, 0x63,
			0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00,
		},
		'N': {
			0x66, 0x77, 0x7F, 0x7F, 0x7F, 0x77, 0x77, 0x33,
			0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00,
		},
		'O': {
			0x7C, 0xFE, 0xE7, 0xE7, 0xE7, 0xE7, 0x7F, 0x3E,
			0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00,
		},
		'P': {
			0xFC, 0xFE, 0xE7, 0xFF, 0xFE, 0xE0, 0xE0, 0x60,
			0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0, 0xC0, 0x00,
		},
		'Q': {
			0x3C, 0x7E, 0x77, 0x77, 0x7B, 0x7D, 0x36, 0x1B,
			0x3C, 0x66, 0x66, 0x66, 0x6A, 0x6C, 0x36, 0x00,
		},
		'R': {
			0xFC, 0xFE, 0xE7, 0xFF, 0xFE, 0xE6, 0xE7, 0x63,
			0xFC, 0xC6, 0xC6, 0xFC, 0xCC, 0xC6, 0xC6, 0x00,
		},
		'S': {
			0x3C, 0x7E, 0x73, 0x3C, 0x1E, 0x67, 0x3F, 0x1E,
			0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00,
		},
		'T': {
			0x7E, 0x3F, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x0C,
			0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00,
		},
		'U': {
			0x66, 0x77, 0x77, 0x77, 0x77, 0x77, 0x3F, 0x1E,
			0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00,
		},
		'V': {
			0x66, 0x77, 0x77, 0x77, 0x77, 0x3F, 0x1E, 0x0C,
			0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00,
		},
		'W': {
			0x66, 0x77, 0x77, 0x77, 0x7F, 0x7F, 0x7F, 0x33,
			0x66, 0x66, 0x66, 0x66, 0x7E, 0x7E, 0x66, 0x00,
		},
		'X': {
			0x66, 0x77, 0x3F, 0x1E, 0x3C, 0x7E, 0x77, 0x33,
			0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00,
		},
		'Y': {
			0x66, 0x77, 0x77, 0x3F, 0x1E, 0x1C, 0x1C, 0x0C,
			0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00,
		},
		'Z': {
			0x7E, 0x3F, 0x0F, 0x1E, 0x3C, 0x78, 0x7E, 0x3F,
			0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00,
		},
		' ': {
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		},
	}

	fontPalette = FontPalette{
		{0, 0, 0},
		{50, 50, 50},
		{100, 100, 100},
		{255, 255, 255},
	}
)

// MRAK: FontTile の定義
type FontTile [ppu.TILE_SIZE * 2]uint8

// MARK: FontPalette の定義
type FontPalette [4][3]uint8

// MARK: 指定された座標にタイルを描画する関数
func DrawTile(canvas *ppu.Canvas, x, y int, tile FontTile) {
	for row := range ppu.TILE_SIZE {
		upper := tile[row]
		lower := tile[row+ppu.TILE_SIZE]

		for column := range ppu.TILE_SIZE {
			// 最上位ビットから順に描画 (左から右へ)
			index := ppu.TILE_SIZE - column - 1
			value := (((lower >> uint8(index)) & 1) << 1) | ((upper >> index) & 1)
			color := fontPalette[value]
			canvas.SetPixelAt(uint(x)+column, uint(y)+row, color)
		}
	}
}

// MARK: 指定された座標にタイルフォントを描画する関数
func DrawText(canvas *ppu.Canvas, x, y int, text string) {
	startX := x
	for _, char := range text {
		if tile, ok := bitmapFonts[char]; ok {
			DrawTile(canvas, x, y, tile)
		}
		x += int(ppu.TILE_SIZE)
		if x > int(canvas.Width-ppu.TILE_SIZE) {
			x = startX
			y += int(ppu.TILE_SIZE)
		}
	}
}

// MARK: 画面をクリアする関数
func ClearScreen(canvas *ppu.Canvas, color [3]uint8) {
	for y := range canvas.Height {
		for x := range canvas.Width {
			canvas.SetPixelAt(x, y, color)
		}
	}
}
